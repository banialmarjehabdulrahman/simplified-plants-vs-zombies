/// Simple helper for "invulnerability frames" (i-frames) after taking damage.
///
/// You can share this between plants and zombies:
/// - If [isActive] is true, they should ignore further damage.
/// - Call [trigger] when a hit is successfully applied.
/// - Call [update] every frame with dt to tick down the timer.
class HitInvulnerability {
  HitInvulnerability({required this.duration})
    : assert(duration >= 0, 'duration must be >= 0');

  /// How long the entity stays invulnerable after a hit (in seconds).
  final double duration;

  /// How much time is left in the current invulnerability period.
  double _remaining = 0.0;

  /// True while the entity is currently invulnerable.
  bool get isActive => _remaining > 0.0;

  /// True if the entity is allowed to receive a hit right now.
  bool get canTakeHit => !isActive;

  /// A value in [0, 1] indicating how "far along" the current
  /// i-frame period is. 1 = just triggered, 0 = finished.
  ///
  /// Useful for animations / flashing effects if you want later.
  double get normalized {
    if (duration <= 0) return 0.0;
    final v = _remaining / duration;
    if (v < 0) return 0.0;
    if (v > 1) return 1.0;
    return v;
  }

  /// Start a new invulnerability period from full [duration].
  void trigger() {
    if (duration <= 0) return;
    _remaining = duration;
  }

  /// Advance the internal timer.
  ///
  /// Call this once per frame, usually from the owning entity's update().
  void update(double dt) {
    if (_remaining <= 0) return;
    _remaining -= dt;
    if (_remaining < 0) {
      _remaining = 0;
    }
  }

  /// Completely clear any active invulnerability.
  void reset() {
    _remaining = 0.0;
  }
}
